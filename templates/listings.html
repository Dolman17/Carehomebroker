{% extends "base.html" %}
{% block title %}Listings{% endblock %}

{% block content %}

{% set can_edit_copy = current_user.is_authenticated and current_user.role in ['admin', 'valuer'] %}

{# ------------------------------------------------------------------
   GATING LOGIC
   ------------------------------------------------------------------ #}
{% set can_view_sensitive = false %}
{% set is_buyer = current_user.is_authenticated and current_user.role == "buyer" %}

{% if current_user.is_authenticated %}
  {% if current_user.role in ["seller", "admin", "valuer"] %}
    {% set can_view_sensitive = true %}
  {% elif current_user.role == "buyer" and is_premium_buyer %}
    {% set can_view_sensitive = true %}
  {% endif %}
{% endif %}

{# ------------------------------------------------------------------
   HEADER + GATING BANNERS
   ------------------------------------------------------------------ #}
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
  <div>
    {% set slug = "listings_header_title" %}
    <h1 class="text-xl font-semibold text-white">
      {{ page_text(slug, "Available Care Homes") }}
      {% if can_edit_copy %}
        <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
           class="ml-2 text-[10px] text-kaijoYellow underline">Edit</a>
      {% endif %}
    </h1>

    {% set slug = "listings_header_subtitle" %}
    <p class="text-xs text-white/70">
      {{ page_text(slug, "A curated, confidential marketplace of live opportunities.") }}
      {% if can_edit_copy %}
        <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
           class="ml-2 text-[9px] text-kaijoYellow underline">Edit</a>
      {% endif %}
    </p>
  </div>

  <a href="{{ url_for('index') }}"
     class="text-xs border border-white/25 text-white/80 px-3 py-2 rounded hover:bg-white/10 hover:text-kaijoYellow transition">
    ← Back to home
  </a>
</div>

{# Logged-in buyer, but NOT premium #}
{% if is_buyer and not is_premium_buyer %}
  <div class="mb-5 rounded-lg border border-kaijoYellow/70 bg-black/40 px-4 py-3 text-xs">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div>
        {% set slug = "listings_buyer_basic_title" %}
        <p class="font-semibold text-kaijoYellow">
          {{ page_text(slug, "You’re on Buyer Basic.") }}
          {% if can_edit_copy %}
            <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
               class="ml-2 text-[9px] text-kaijoYellow underline">Edit</a>
          {% endif %}
        </p>

        {% set slug = "listings_buyer_basic_body" %}
        <p class="text-white/80 mt-1">
          {{ page_text(
            slug,
            "Listings are partially blurred in Basic mode. Upgrade to Buyer Premium to see service names, guide prices and unlock full enquiry tools."
          ) }}
          {% if can_edit_copy %}
            <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
               class="ml-2 text-[9px] text-kaijoYellow underline">Edit</a>
          {% endif %}
        </p>
      </div>
      <div class="flex flex-col sm:items-end gap-2 sm:min-w-[180px]">
        {% set slug = "listings_buyer_basic_cta" %}
        <a href="{{ url_for('pricing', role='buyer') }}"
           class="inline-flex items-center justify-center px-4 py-2 rounded bg-kaijoPink text-white text-[11px] font-semibold hover:bg-kaijoYellow hover:text-black transition">
          {{ page_text(slug, "View Buyer Premium options") }}
          {% if can_edit_copy %}
            <span class="ml-2 text-[9px] text-black/80 underline">Edit</span>
          {% endif %}
        </a>

        {% set slug = "listings_buyer_basic_note" %}
        <p class="text-[10px] text-white/50">
          {{ page_text(slug, "Premium unlocks full marketplace access & enquiry workflows.") }}
          {% if can_edit_copy %}
            <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
               class="ml-1 text-[9px] text-kaijoYellow underline">Edit</a>
          {% endif %}
        </p>
      </div>
    </div>
  </div>

{# Logged out - gentle CTA #}
{% elif not current_user.is_authenticated %}
  <div class="mb-5 rounded-lg border border-white/15 bg-black/30 px-4 py-3 text-xs text-white">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div>
        {% set slug = "listings_logged_out_title" %}
        <p class="font-semibold">
          {{ page_text(slug, "Log in or register to see more detail") }}
          {% if can_edit_copy %}
            <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
               class="ml-2 text-[9px] text-kaijoYellow underline">Edit</a>
          {% endif %}
        </p>

        {% set slug = "listings_logged_out_body" %}
        <p class="text-white/80 mt-1">
          {{ page_text(
            slug,
            "Service names and guide prices are kept confidential. Create a buyer account and upgrade to Buyer Premium to unlock full access."
          ) }}
          {% if can_edit_copy %}
            <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
               class="ml-2 text-[9px] text-kaijoYellow underline">Edit</a>
          {% endif %}
        </p>
      </div>
      <div class="flex flex-col sm:items-end gap-2 sm:min-w-[220px]">
        <div class="flex gap-2">
          <a href="{{ url_for('login') }}"
             class="px-3 py-1.5 rounded bg-white text-gray-900 text-[11px] font-semibold hover:bg-kaijoYellow hover:text-black transition">
            Log in
          </a>
          <a href="{{ url_for('pricing', role='buyer') }}"
             class="px-3 py-1.5 rounded border border-white text-[11px] hover:bg-white/10 hover:text-kaijoYellow transition">
            Buyer options
          </a>
        </div>

        {% set slug = "listings_logged_out_note" %}
        <p class="text-[10px] text-white/50">
          {{ page_text(
            slug,
            "The marketplace is confidential. We only show full details to registered buyers."
          ) }}
          {% if can_edit_copy %}
            <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
               class="ml-1 text-[9px] text-kaijoYellow underline">Edit</a>
          {% endif %}
        </p>
      </div>
    </div>
  </div>
{% endif %}

{# ------------------------------------------------------------------
   LISTING GRID
   ------------------------------------------------------------------ #}
{% if listings %}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for l in listings %}
      <a href="{{ url_for('listing_detail', listing_id=l.id) }}"
         class="block rounded-lg
                bg-white/5 border border-white/10
                hover:bg-white/10 hover:border-kaijoYellow/70
                transition shadow-sm backdrop-blur-sm overflow-hidden">

        {# Thumbnail / primary photo #}
        {% set photos = l.photos or [] %}
        <div class="w-full h-40 bg-black/30 overflow-hidden">
          {% if photos %}
            {% set first_photo = photos[0] %}
            {% set photo_filename = first_photo.file_name
                                     or first_photo.filename
                                     or first_photo.image_path
                                     or '' %}
            {% if photo_filename %}
              <img
                src="{{ url_for('static', filename='uploads/' ~ photo_filename) }}"
                alt="Listing image"
                class="w-full h-full object-cover"
                loading="lazy"
              >
            {% else %}
              <div class="w-full h-full flex items-center justify-center text-[10px] text-gray-400">
                No photo available
              </div>
            {% endif %}
          {% else %}
            <div class="w-full h-full flex items-center justify-center text-[10px] text-gray-400">
              No photo available
            </div>
          {% endif %}
        </div>

        <div class="p-4">
          {# Code #}
          <p class="text-[11px] font-mono text-white/40 mb-1">
            {{ l.listing_code or "Ref pending" }}
          </p>

          {# TITLE – confidential gating #}
          {% if can_view_sensitive %}
            <p class="font-semibold text-sm text-white mb-1">
              {{ l.title }}
            </p>
          {% else %}
            {% set slug = "listings_card_confidential_title" %}
            <p class="font-semibold text-sm text-white mb-1">
              {{ page_text(slug, "Confidential care home opportunity") }}
              {% if can_edit_copy %}
                <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
                   class="ml-1 text-[9px] text-kaijoYellow underline">Edit</a>
              {% endif %}
            </p>
          {% endif %}

          {# Meta #}
          <p class="text-[11px] text-white/60 mb-1">
            {{ l.region or "Region confidential" }} •
            {{ l.care_type or "Care type confidential" }} •
            {{ l.beds or "?" }} beds
          </p>

          {# GUIDE PRICE – blur for non-premium buyers + public #}
          {% set slug = "listings_card_guide_price_label" %}
          <p class="text-[11px] text-white/60">
            {{ page_text(slug, "Guide price:") }}
            {% if can_edit_copy %}
              <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
                 class="ml-1 text-[9px] text-kaijoYellow underline">Edit</a>
            {% endif %}

            {% if can_view_sensitive %}
              <span class="text-kaijoYellow">
                {{ l.guide_price_band or "On request" }}
              </span>
            {% else %}
              {% set slug = "listings_card_guide_price_placeholder" %}
              <span class="blur-sm select-none">
                {{ l.guide_price_band or page_text(slug, "£X,XXX,XXX") }}
              </span>
              <span class="ml-1 text-[10px] text-kaijoYellow/90">
                Premium only
              </span>
            {% endif %}
          </p>
        </div>
      </a>
    {% endfor %}
  </div>
{% else %}
  {% set slug = "listings_no_results" %}
  <p class="text-sm text-white/75">
    {{ page_text(
      slug,
      "No live listings are available right now. New opportunities will appear here as sellers choose to go live."
    ) }}
    {% if can_edit_copy %}
      <a href="{{ url_for('admin_edit_content', slug=slug, next=request.path) }}"
         class="ml-2 text-[9px] text-kaijoYellow underline">Edit</a>
    {% endif %}
  </p>
{% endif %}

{% endblock %}
