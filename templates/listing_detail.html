{% extends "base.html" %}
{% block title %}{{ listing.title }} – Listing{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto py-8 text-white">

  {# Compute gating flags #}
  {% set can_see_full_title = false %}
  {% set can_see_price = false %}

  {% if current_user.is_authenticated %}
    {% if current_user.role == "admin" %}
      {% set can_see_full_title = true %}
      {% set can_see_price = true %}
    {% elif current_user.role == "seller" and listing.seller_id == current_user.id %}
      {% set can_see_full_title = true %}
      {% set can_see_price = true %}
    {% elif current_user.role == "buyer" and is_premium_buyer %}
      {% set can_see_full_title = true %}
      {% set can_see_price = true %}
    {% endif %}
  {% endif %}

  <!-- HEADER -->
  <div class="flex items-center justify-between mb-4">
    <div>
      <p class="text-[11px] font-mono text-white/40 mb-1">{{ listing.listing_code }}</p>
      <h1 class="text-2xl font-semibold">
        {% if can_see_full_title %}
          {{ listing.title }}
        {% else %}
          Confidential care home – {{ listing.region or "UK" }}
        {% endif %}
      </h1>
      <p class="text-xs text-white/60 mt-1">
        {{ listing.region or "Region tbc" }} •
        {{ listing.care_type or "Care type tbc" }} •
        {{ listing.beds or "?" }} beds
      </p>
    </div>

    {% if current_user.is_authenticated and current_user.role == "buyer" %}
      <form action="{{ url_for('toggle_shortlist', listing_id=listing.id) }}"
            method="post"
            class="inline-block">
        <input type="hidden" name="next" value="{{ request.path }}">
        <button type="submit"
                class="px-3 py-1.5 text-[11px] rounded border border-white/20 hover:bg-white/10 flex items-center gap-1">
          {% if is_shortlisted %}
            ★ Shortlisted
          {% else %}
            ☆ Add to shortlist
          {% endif %}
        </button>
      </form>
    {% endif %}
  </div>

  <!-- PREMIUM / LOGIN BANNERS -->
  {% if current_user.is_authenticated and current_user.role == "buyer" and not is_premium_buyer %}
    <div class="mb-5 rounded-lg border border-kaijoYellow/60 bg-black/20 px-4 py-3 text-xs text-kaijoYellow">
      <div class="font-semibold mb-1">Buyer Premium required for full access</div>
      <p class="mb-2 text-white/80">
        Upgrade to Buyer Premium to unlock full financials and send structured enquiries.
      </p>
      <a href="{{ url_for('pricing', role='buyer') }}"
         class="inline-flex items-center px-3 py-1.5 rounded bg-kaijoPink text-white font-semibold text-[11px] hover:bg-kaijoYellow hover:text-black transition">
        View buyer plans
      </a>
    </div>

  {% elif not current_user.is_authenticated %}
    <div class="mb-5 rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-xs text-white">
      <div class="font-semibold mb-1">Log in to see more</div>
      <p class="mb-2 text-white/80">
        Log in or register as a buyer to view full headline figures and send an enquiry.
      </p>
      <div class="space-x-2">
        <a href="{{ url_for('login', next=request.path) }}"
           class="inline-flex items-center px-3 py-1.5 rounded bg-white text-gray-900 font-semibold text-[11px]">
          Log in
        </a>
        <a href="{{ url_for('register_buyer') }}"
           class="inline-flex items-center px-3 py-1.5 rounded border border-white text-white text-[11px]">
          Register as buyer
        </a>
      </div>
    </div>
  {% endif %}

  <!-- MAIN GRID -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

    <!-- LEFT CONTENT -->
    <div class="md:col-span-2 space-y-4">

      <!-- Overview -->
      <div class="rounded-lg border border-white/10 bg-white/5 p-4 text-sm">
        <h2 class="text-sm font-semibold mb-2">Overview</h2>
        <p class="text-xs text-white/80">
          {{ listing.short_description or "No description provided by the seller yet." }}
        </p>
      </div>

      <!-- Headline figures -->
      <div class="rounded-lg border border-white/10 bg-white/5 p-4 text-sm">
        <h2 class="text-sm font-semibold mb-3">Headline figures</h2>

        <dl class="grid grid-cols-2 gap-y-3 text-xs">

          <!-- GUIDE PRICE -->
          <div>
            <dt class="text-white/40">Guide price</dt>
            <dd class="mt-0.5">
              {% if can_see_price %}
                {{ listing.guide_price_band or "On request" }}
              {% else %}
                <span class="blur-sm select-none">£X,XXX,XXX</span>
                <span class="ml-1 text-[10px] text-kaijoYellow">Premium only</span>
              {% endif %}
            </dd>
          </div>

          <div>
            <dt class="text-white/40">Occupancy</dt>
            <dd class="mt-0.5">{{ listing.occupancy_percent or "n/a" }}%</dd>
          </div>

          <div>
            <dt class="text-white/40">CQC Rating</dt>
            <dd class="mt-0.5">{{ listing.cqc_rating or "Not disclosed" }}</dd>
          </div>

          <div>
            <dt class="text-white/40">Tenure</dt>
            <dd class="mt-0.5">{{ listing.tenure or "Not disclosed" }}</dd>
          </div>

        </dl>
      </div>

    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="space-y-4">

      <!-- Enquiry box -->
      <div class="rounded-lg border border-white/10 bg-white/5 p-4 text-sm">
        <h2 class="text-sm font-semibold mb-3">Enquire</h2>

        {% if can_enquire %}
          <form method="post" class="space-y-3">

            <!-- Message -->
            <div>
              <label class="block text-xs font-medium mb-1" for="message">Message *</label>
              <textarea id="message" name="message" rows="4"
                        class="w-full rounded border border-white/20 bg-black/20 px-3 py-2 text-xs text-white"
                        required></textarea>
              <p class="text-[10px] text-white/60 mt-1">
                Introduce yourself, funding position, and preferred viewing times.
              </p>
            </div>

            <!-- NDA -->
            <div class="flex items-center gap-2">
              <input type="checkbox"
                     id="nda_accepted"
                     name="nda_accepted"
                     class="h-3 w-3 rounded border-white/30 bg-black/40">
              <label for="nda_accepted" class="text-[11px] text-white/70">
                I agree to keep these details confidential.
              </label>
            </div>

            <button type="submit"
                    class="w-full px-4 py-2 rounded bg-kaijoPink text-white hover:bg-kaijoYellow hover:text-black text-xs font-semibold transition">
              Send enquiry
            </button>

          </form>

        {% elif current_user.is_authenticated and current_user.role == "buyer" %}
          <p class="text-xs text-white/70">
            Upgrade to Buyer Premium to contact sellers directly.
          </p>
          <a href="{{ url_for('pricing', role='buyer') }}"
             class="mt-3 inline-flex items-center px-3 py-1.5 rounded bg-kaijoPink text-white text-[11px] font-semibold hover:bg-kaijoYellow hover:text-black transition">
            Upgrade to Buyer Premium
          </a>

        {% else %}
          <p class="text-xs text-white/70 mb-2">
            Log in or register as a buyer to send an enquiry.
          </p>
          <div class="space-x-2">
            <a href="{{ url_for('login', next=request.path) }}"
               class="inline-flex items-center px-3 py-1.5 rounded bg-white text-gray-900 font-semibold text-[11px]">
              Log in
            </a>
            <a href="{{ url_for('register_buyer') }}"
               class="inline-flex items-center px-3 py-1.5 rounded border border-white text-[11px]">
              Register
            </a>
          </div>
        {% endif %}
      </div>

    </div>

  </div>
</div>
{% endblock %}
