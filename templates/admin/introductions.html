{% extends "base.html" %}
{% block title %}Introductions – Admin{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-xl font-semibold text-white">Introductions pipeline</h1>
    <p class="text-xs text-white/70">
      Track buyer–seller introductions from first contact through to completed deals.
    </p>
  </div>
</div>

<div class="overflow-x-auto pb-4">
  <div class="min-w-max grid gap-4"
       style="grid-template-columns: repeat({{ statuses|length }}, minmax(220px, 1fr));">

    {% for key, label in statuses %}
      {% set column_intros = status_columns.get(key, []) %}

      <div class="bg-black/30 border border-white/10 rounded-lg p-3 flex flex-col max-h-[80vh]">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xs font-semibold uppercase tracking-[0.18em] text-white/70">
            {{ label }}
          </h2>
          <span class="text-[10px] px-2 py-0.5 rounded-full bg-white/5 text-white/60">
            {{ column_intros|length }}
          </span>
        </div>

        <div class="space-y-2 overflow-y-auto pr-1">
          {% if column_intros %}
            {% for intro in column_intros %}
              <a href="{{ url_for('admin_introduction_detail', intro_id=intro.id) }}"
                 class="block bg-white/5 border border-white/10 rounded-md p-3 hover:border-kaijoYellow/80 hover:bg-white/10 transition text-xs text-white/80">

                <div class="flex items-center justify-between mb-1">
                  <span class="font-mono text-[10px] text-white/50">
                    {{ intro.listing.listing_code or "Ref " ~ intro.listing.id }}
                  </span>
                  <span class="text-[10px] text-white/40">
                    {{ intro.created_at.strftime("%d %b %Y") }}
                  </span>
                </div>

                <p class="text-[11px] font-semibold text-white line-clamp-2">
                  {{ intro.listing.title }}
                </p>

                <p class="text-[10px] text-white/60 mt-1">
                  Buyer: {{ intro.buyer.email }}
                  {% if intro.buyer.buyer_profile and intro.buyer.buyer_profile.business_name %}
                    · {{ intro.buyer.buyer_profile.business_name }}
                  {% endif %}
                </p>

                <p class="text-[10px] text-white/50">
                  Seller: {{ intro.seller.email }}
                </p>

                {% if intro.deal %}
                  <div class="mt-2 text-[10px] text-kaijoYellow/90">
                    Deal: {{ intro.deal.agreed_price or "TBC" }}
                    {% if intro.deal.status == "completed" %}
                      · <span class="text-green-300">Completed</span>
                    {% endif %}
                  </div>
                {% endif %}
              </a>
            {% endfor %}
          {% else %}
            <p class="text-[11px] text-white/40 italic">
              No introductions in this stage yet.
            </p>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
