{% extends "base.html" %}
{% block title %}Buyer Dashboard – Care Home Broker{% endblock %}

{% block content %}
<div class="space-y-6 text-white">

  <!-- HEADER -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h1 class="text-xl sm:text-2xl font-semibold">Buyer Dashboard</h1>
      <p class="text-xs text-white/70">
        See your matches, shortlist, and enquiries – all in one place.
      </p>
    </div>

    <a href="{{ url_for('buyer_profile') }}"
       class="inline-flex items-center justify-center text-xs px-3 py-2 rounded border border-white/20 text-white/90 hover:bg-white/10 hover:text-kaijoYellow transition">
      ✏️ Update buyer profile
    </a>
  </div>

  {% if current_plan_label %}
  <div class="mb-4 flex flex-wrap items-center justify-between gap-3 text-xs">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/15 text-white/80">
      <span class="text-[10px] uppercase tracking-[0.2em] text-white/50">Your plan</span>
      <span class="font-semibold text-kaijoYellow">{{ current_plan_label }}</span>
    </div>

    <form method="POST" action="{{ url_for('billing_portal') }}">
      <button type="submit"
              class="px-3 py-1.5 rounded border border-white/25 text-white/80 text-[11px] hover:bg-white/10 hover:text-kaijoYellow transition">
        Manage billing
      </button>
    </form>
  </div>
  {% else %}
  <div class="mb-4 text-[11px] text-white/60">
    You don’t have an active subscription yet.
    <a href="{{ url_for('pricing', role='buyer') }}" class="underline hover:text-kaijoYellow">
      Choose a plan
    </a>
  </div>
  {% endif %}

  <!-- PREMIUM GATING + PROFILE STATUS -->
  <div class="grid md:grid-cols-2 gap-4">

    <!-- Profile completion card -->
    <div class="rounded-lg border border-white/10 bg-black/30 p-4 text-xs">
      <h2 class="text-sm font-semibold mb-2">Your buyer profile</h2>

      {% if profile_complete %}
        <p class="text-white/70 mb-2">
          Your profile is <span class="text-kaijoYellow font-semibold">deal-ready</span>.
          We’re using it to rank and prioritise opportunities for you.
        </p>
      {% else %}
        <p class="text-white/70 mb-2">
          Your profile is <span class="text-kaijoPink font-semibold">incomplete</span>.
          Add your budget, regions and strategy to improve match quality.
        </p>
        <a href="{{ url_for('buyer_profile') }}"
           class="inline-flex items-center px-3 py-1.5 rounded bg-kaijoPink text-white hover:bg-kaijoYellow hover:text-black transition">
          Complete your buyer profile
        </a>
      {% endif %}
    </div>

    <!-- Premium status card -->
    <div class="rounded-lg border border-white/10 bg-black/30 p-4 text-xs">
      <h2 class="text-sm font-semibold mb-2">Marketplace access</h2>

      {% if is_premium_buyer %}
        <p class="text-white/70 mb-1">
          You are on <span class="text-kaijoYellow font-semibold">Buyer Premium</span>.
          You can see full listing details and send structured enquiries.
        </p>
        <p class="text-white/50">
          Use your matches below to prioritise which opportunities to move forward first.
        </p>
      {% else %}
        <p class="text-white/80 mb-2">
          You are on the <span class="font-semibold">Register-only</span> tier.
          You’ll see blurred headline details – upgrade to unlock full listings and enquiry tools.
        </p>
        <a href="{{ url_for('pricing', role='buyer') }}"
           class="inline-flex items-center px-3 py-1.5 rounded bg-kaijoPink text-white font-semibold hover:bg-kaijoYellow hover:text-black transition">
          View Buyer Premium options
        </a>
        <p class="mt-2 text-[11px] text-white/50">
          Premium unlocks: full listing names & guide prices, enquiry tools and curated intros.
        </p>
      {% endif %}
    </div>

  </div>

  <!-- MATCHES -->
  <section class="rounded-lg border border-white/10 bg-black/30 p-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
      <div>
        <h2 class="text-sm font-semibold">Matches based on your profile</h2>
        <p class="text-[11px] text-white/60">
          Ranked by fit against your regions, care types, beds and budget.
        </p>
      </div>
      <a href="{{ url_for('listings') }}"
         class="text-[11px] text-white/70 hover:text-kaijoYellow underline-offset-2 hover:underline">
        Browse all live listings →
      </a>
    </div>

    {% if top_matches %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        {% for l in top_matches %}
          <a href="{{ url_for('listing_detail', listing_id=l.id) }}"
             class="block rounded-md border border-white/10 bg-black/40 p-3 hover:border-kaijoYellow/80 hover:shadow-lg hover:shadow-black/40 transition">

            <p class="text-[10px] font-mono text-white/40 mb-1">
              {{ l.listing_code or "Ref pending" }}
            </p>

            <!-- Service name: blurred for non-premium -->
            <p class="font-semibold text-sm mb-1">
              {% if is_premium_buyer %}
                {{ l.title }}
              {% else %}
                <span class="blur-sm select-none">Confidential care home</span>
                <span class="ml-1 text-[10px] text-kaijoYellow">Premium only</span>
              {% endif %}
            </p>

            <p class="text-[11px] text-white/70 mb-1">
              {{ l.region or "Region tbc" }} •
              {{ l.care_type or "Care type tbc" }} •
              {{ l.beds or "?" }} beds
            </p>

            <p class="text-[11px] text-white/60">
              Guide price:
              {% if is_premium_buyer %}
                <span class="text-kaijoYellow">
                  {{ l.guide_price_band or "On request" }}
                </span>
              {% else %}
                <span class="blur-sm select-none">£X,XXX,XXX</span>
                <span class="ml-1 text-[10px] text-kaijoYellow">Premium only</span>
              {% endif %}
            </p>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-xs text-white/70">
        No strong matches yet. Once your profile is complete and more listings go live,
        we’ll surface your top opportunities here.
      </p>
    {% endif %}
  </section>

  <!-- TWO COLUMN: ENQUIRIES + SHORTLIST -->
  <div class="grid md:grid-cols-2 gap-4">

    <!-- Recent enquiries -->
    <section class="rounded-lg border border-white/10 bg-black/30 p-4">
      <h2 class="text-sm font-semibold mb-2">Recent enquiries</h2>

      {% if enquiries %}
        <div class="space-y-2 max-h-64 overflow-y-auto pr-1">
          {% for e in enquiries %}
            {% set l = e.listing %}
            <div class="border border-white/10 rounded-md px-3 py-2 text-[11px]">
              <div class="flex items-center justify-between gap-2 mb-1">
                <span class="font-mono text-white/50">
                  {{ l.listing_code if l else "Listing removed" }}
                </span>
                <span class="text-white/40">
                  {{ e.created_at.strftime("%d %b %Y") }}
                </span>
              </div>
              {% if l %}
                <p class="text-white/80 text-xs mb-1">
                  {{ l.title }}
                </p>
              {% endif %}
              <p class="text-white/60 line-clamp-2">
                {{ e.message }}
              </p>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-xs text-white/70">
          {% if is_premium_buyer %}
            You haven’t sent any enquiries yet. From listing pages, use the enquiry form to contact sellers directly.
          {% else %}
            You haven’t sent any enquiries yet. Once you upgrade to Premium, you can contact sellers directly from listing pages.
          {% endif %}
        </p>
      {% endif %}
    </section>

    <!-- Shortlist -->
    <section class="rounded-lg border border-white/10 bg-black/30 p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold">Shortlist</h2>
        <a href="{{ url_for('buyer_shortlist') }}"
           class="text-[11px] text-white/70 hover:text-kaijoYellow underline-offset-2 hover:underline">
          View full shortlist →
        </a>
      </div>

      {% if shortlist_listings %}
        <div class="space-y-2 max-h-64 overflow-y-auto pr-1">
          {% for l in shortlist_listings %}
            <a href="{{ url_for('listing_detail', listing_id=l.id) }}"
               class="block border border-white/10 rounded-md px-3 py-2 text-[11px] hover:border-kaijoYellow/70 transition">
              <div class="flex items-center justify-between gap-2 mb-1">
                <span class="font-mono text-white/50">
                  {{ l.listing_code or "Ref" }}
                </span>
                <span class="text-white/40">
                  {{ l.region or "Region" }}
                </span>
              </div>
              <p class="text-white/80 text-xs mb-0.5">
                {% if is_premium_buyer %}
                  {{ l.title }}
                {% else %}
                  <span class="blur-sm select-none">Confidential care home</span>
                  <span class="ml-1 text-[10px] text-kaijoYellow">Premium</span>
                {% endif %}
              </p>
              <p class="text-white/60">
                {{ l.care_type or "Care type" }} • {{ l.beds or "?" }} beds
              </p>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-xs text-white/70">
          You haven’t shortlisted any homes yet. From listings, use “☆ Add to shortlist” to keep track of interesting opportunities.
        </p>
      {% endif %}
    </section>

  </div>

</div>
{% endblock %}
